<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM Connect - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { primary: '#2563eb', secondary: '#10b981', accent: '#f59e0b', dark: '#0f172a' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="navigate('home')">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-blue-700 rounded-xl flex items-center justify-center text-white mr-3 shadow-lg">
                        <i class="fas fa-hands-helping"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-dark">UMKM <span class="text-primary">Connect</span></span>
                </div>

                <div id="nav-user" class="hidden flex items-center space-x-2 sm:space-x-4">
                    <button onclick="navigate('dashboard')" class="p-2 text-slate-500 hover:text-primary transition"><i class="fas fa-th-large"></i></button>
                    <button id="nav-finance-btn" onclick="navigate('finance')" class="hidden p-2 text-slate-500 hover:text-primary transition"><i class="fas fa-calculator"></i></button>
                    <button onclick="navigate('chat')" class="p-2 text-slate-500 hover:text-primary transition relative">
                        <i class="fas fa-comments"></i>
                    </button>
                    <div class="h-8 w-px bg-slate-200 mx-2"></div>
                    <button onclick="navigate('profile')" class="flex items-center space-x-2 p-1 rounded-full hover:bg-slate-100 transition">
                        <img id="nav-avatar" src="" class="w-8 h-8 rounded-full border border-primary/20 object-cover">
                    </button>
                    <button onclick="logout()" class="p-2 text-red-400 hover:text-red-600 transition"><i class="fas fa-power-off"></i></button>
                </div>

                <div id="nav-guest" class="flex items-center space-x-4">
                    <button onclick="navigate('auth')" class="text-slate-600 font-medium hover:text-primary">Masuk</button>
                    <button onclick="navigate('auth')" class="bg-primary text-white px-5 py-2 rounded-full font-semibold hover:bg-blue-700 transition">Mulai</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Loading Overlay -->
        <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[200] flex items-center justify-center hidden">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 font-bold text-primary">Sinkronisasi Data...</p>
            </div>
        </div>

        <!-- LANDING -->
        <section id="page-home" class="page-section active text-center py-20">
            <h1 class="text-5xl font-extrabold text-dark mb-6">Cloud UMKM Ecosystem</h1>
            <p class="text-slate-500 max-w-2xl mx-auto mb-10">Data Anda tersimpan dengan aman dan dapat diakses kapan saja, di mana saja.</p>
            <button onclick="navigate('auth')" class="bg-primary text-white px-10 py-4 rounded-full font-bold text-lg shadow-xl hover:scale-105 transition-all">Masuk Sekarang</button>
            <div class="mt-16 grid grid-cols-2 md:grid-cols-4 gap-4 opacity-50 grayscale italic text-sm">
                <div>Backup Otomatis</div>
                <div>Multi Perangkat</div>
                <div>Real-time Chat</div>
                <div>Laporan AI</div>
            </div>
        </section>

        <!-- AUTH -->
        <section id="page-auth" class="page-section">
            <div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl border overflow-hidden">
                <div class="p-8">
                    <h2 class="text-2xl font-bold mb-2">Selamat Datang Kembali</h2>
                    <p class="text-slate-400 text-sm mb-8">Gunakan akun dummy atau daftar baru.</p>
                    <form onsubmit="handleAuth(event)">
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Email</label>
                            <input type="email" id="auth-email" class="w-full px-5 py-3 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-primary" placeholder="contoh: kopi@dummy.com" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Password</label>
                            <input type="password" id="auth-pass" class="w-full px-5 py-3 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-primary" placeholder="123456" required>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg">Masuk</button>
                    </form>
                    <div class="mt-6 p-4 bg-amber-50 rounded-2xl text-xs text-amber-700">
                        <p class="font-bold mb-1">Akun Dummy Tersedia:</p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li>kopi@dummy.com (UMKM)</li>
                            <li>barista@dummy.com (Pekerja)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="page-section">
            <div id="dash-umkm" class="hidden">
                <h2 class="text-3xl font-bold mb-8">Dashboard <span id="dash-shop" class="text-primary italic"></span></h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-3xl border shadow-sm">
                        <p class="text-slate-400 text-sm">Saldo</p>
                        <h3 id="dash-balance" class="text-2xl font-bold">Rp 0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border shadow-sm">
                        <p class="text-slate-400 text-sm">Status Cloud</p>
                        <h3 class="text-2xl font-bold text-green-500"><i class="fas fa-cloud-upload-alt mr-2"></i>Aktif</h3>
                    </div>
                </div>
                <div class="bg-dark p-8 rounded-[2rem] text-white flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-xl">Butuh Pekerja Baru?</h4>
                        <p class="text-slate-400 text-sm">Posting lowongan dan temukan talenta lokal.</p>
                    </div>
                    <button onclick="navigate('jobs')" class="bg-primary px-6 py-3 rounded-xl font-bold">Kelola Lowongan</button>
                </div>
            </div>

            <div id="dash-worker" class="hidden">
                <h2 class="text-3xl font-bold mb-8">Halo, <span id="dash-worker-name" class="text-primary"></span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="jobs-container">
                    <!-- Jobs from Firestore -->
                </div>
            </div>
        </section>

        <!-- CHAT -->
        <section id="page-chat" class="page-section h-[70vh]">
            <div class="bg-white rounded-3xl border flex h-full overflow-hidden shadow-sm">
                <div class="w-1/3 border-r flex flex-col">
                    <div class="p-6 border-b font-bold text-lg">Pesan</div>
                    <div id="chat-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                </div>
                <div class="flex-1 flex flex-col bg-slate-50">
                    <div id="chat-active-target" class="p-6 bg-white border-b font-bold text-slate-400">Pilih Kontak</div>
                    <div id="chat-messages" class="flex-1 p-6 overflow-y-auto flex flex-col gap-3"></div>
                    <form class="p-4 bg-white border-t flex gap-3" onsubmit="handleSendMessage(event)">
                        <input type="text" id="chat-input" class="flex-1 bg-slate-100 px-6 py-3 rounded-xl outline-none" placeholder="Tulis pesan..." disabled>
                        <button id="chat-send-btn" class="bg-primary text-white px-6 rounded-xl disabled:opacity-50" disabled><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </section>

    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 bg-dark text-white rounded-full font-bold shadow-2xl opacity-0 transition-all pointer-events-none z-[300]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'umkm-connect-v1';

        // State
        let currentUser = null;
        let activeChatId = null;

        // Initialize App & Auth
        const init = async () => {
            showLoading(true);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error(err);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Saat auth siap, pastikan akun dummy ada di Firestore
                await seedDummyAccounts();
                showLoading(false);
            }
        });

        // Seed Dummy Data to Firestore
        const seedDummyAccounts = async () => {
            const dummies = [
                { email: 'kopi@dummy.com', pass: '123456', name: 'Budi', shop: 'Kopi Senja', role: 'umkm', skill: '', desc: 'Kopi lokal terbaik.' },
                { email: 'bakery@dummy.com', pass: '123456', name: 'Sari', shop: 'Roti Manis', role: 'umkm', skill: '', desc: 'Toko roti keluarga.' },
                { email: 'barista@dummy.com', pass: '123456', name: 'Andi', role: 'worker', shop: '', skill: 'Barista', desc: 'Berpengalaman 2 tahun.' },
                { email: 'admin@dummy.com', pass: '123456', name: 'Maya', role: 'worker', shop: '', skill: 'Admin Sosmed', desc: 'Mahir Canva & IG.' },
                { email: 'kurir@dummy.com', pass: '123456', name: 'Bimo', role: 'worker', shop: '', skill: 'Kurir Motor', desc: 'Hafal rute kota.' }
            ];

            for (const d of dummies) {
                const userDoc = doc(db, 'artifacts', appId, 'public', 'data', 'users', d.email);
                const snap = await getDoc(userDoc);
                if (!snap.exists()) {
                    await setDoc(userDoc, { ...d, uid: d.email, avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(d.shop || d.name)}&background=random` });
                }
            }
        };

        // Actions
        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            
            showLoading(true);
            const userDoc = doc(db, 'artifacts', appId, 'public', 'data', 'users', email);
            const snap = await getDoc(userDoc);

            if (snap.exists() && snap.data().pass === pass) {
                currentUser = snap.data();
                updateUIForUser();
                navigate('dashboard');
                showToast(`Halo, ${currentUser.name}!`);
            } else {
                showToast('Email atau password salah!', 'error');
            }
            showLoading(false);
        };

        window.logout = () => {
            currentUser = null;
            updateUIForUser();
            navigate('home');
            showToast('Berhasil keluar.');
        };

        const updateUIForUser = () => {
            const navUser = document.getElementById('nav-user');
            const navGuest = document.getElementById('nav-guest');
            if (currentUser) {
                navUser.classList.remove('hidden');
                navGuest.classList.add('hidden');
                document.getElementById('nav-avatar').src = currentUser.avatar;
                document.getElementById('nav-finance-btn').classList.toggle('hidden', currentUser.role !== 'umkm');
                
                // Dashboard dynamic content
                if (currentUser.role === 'umkm') {
                    document.getElementById('dash-umkm').classList.remove('hidden');
                    document.getElementById('dash-worker').classList.add('hidden');
                    document.getElementById('dash-shop').innerText = currentUser.shop;
                } else {
                    document.getElementById('dash-umkm').classList.add('hidden');
                    document.getElementById('dash-worker').classList.remove('hidden');
                    document.getElementById('dash-worker-name').innerText = currentUser.name;
                    loadAllJobs();
                }
            } else {
                navUser.classList.add('hidden');
                navGuest.classList.remove('hidden');
            }
        };

        // Jobs System (Public Data)
        const loadAllJobs = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'jobs'));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('jobs-container');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const j = doc.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-3xl border shadow-sm hover:shadow-md transition";
                    card.innerHTML = `
                        <div class="flex items-center gap-4 mb-4">
                            <img src="${j.avatar}" class="w-12 h-12 rounded-xl object-cover">
                            <div><h4 class="font-bold">${j.title}</h4><p class="text-primary text-xs font-bold">${j.shopName}</p></div>
                        </div>
                        <button onclick="window.applyJob('${doc.id}', '${j.userId}')" class="w-full bg-primary text-white py-3 rounded-xl text-xs font-bold">Lamar & Chat</button>
                    `;
                    container.appendChild(card);
                });
                if (snap.empty) {
                    container.innerHTML = '<p class="col-span-full text-center text-slate-400 py-10">Belum ada lowongan tersedia.</p>';
                }
            }, (err) => console.error(err));
        };

        window.applyJob = async (jobId, employerEmail) => {
            showToast('Lamaran terkirim! Membuka chat...');
            // In a real app, this would create a link. Here we just open chat to the employer email.
            navigate('chat');
            window.openChat(employerEmail);
        };

        // Chat System (Public Data for Simplicity in Demo)
        window.openChat = async (targetId) => {
            activeChatId = targetId;
            const targetDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId));
            const targetData = targetDoc.data();
            
            document.getElementById('chat-active-target').innerText = `Chat dengan ${targetData.shop || targetData.name}`;
            document.getElementById('chat-active-target').classList.remove('text-slate-400');
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;

            // Listen for messages
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats'));
            onSnapshot(q, (snap) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                // Rule: filter in JS memory
                const msgs = snap.docs
                    .map(d => d.data())
                    .filter(m => (m.from === currentUser.uid && m.to === activeChatId) || (m.from === activeChatId && m.to === currentUser.uid))
                    .sort((a, b) => (a.ts?.seconds || 0) - (b.ts?.seconds || 0));

                msgs.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `flex ${m.from === currentUser.uid ? 'justify-end' : 'justify-start'}`;
                    div.innerHTML = `<div class="px-4 py-2 rounded-2xl text-sm ${m.from === currentUser.uid ? 'bg-primary text-white' : 'bg-white border shadow-sm'}">${m.msg}</div>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            }, (err) => console.error(err));
            
            loadChatList();
        };

        const loadChatList = async () => {
            // Demo: List all dummy accounts except self
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            const snap = await getDocs(q);
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            snap.forEach(d => {
                const u = d.data();
                if (u.uid === currentUser.uid) return;
                const item = document.createElement('div');
                item.className = `p-4 border-b flex items-center gap-3 cursor-pointer hover:bg-slate-50 ${activeChatId === u.uid ? 'bg-blue-50' : ''}`;
                item.onclick = () => window.openChat(u.uid);
                item.innerHTML = `
                    <img src="${u.avatar}" class="w-10 h-10 rounded-xl">
                    <div><h5 class="font-bold text-sm">${u.shop || u.name}</h5><p class="text-[10px] text-slate-400 uppercase font-bold">${u.role}</p></div>
                `;
                list.appendChild(item);
            });
        };

        window.handleSendMessage = async (e) => {
            e.preventDefault();
            const msg = document.getElementById('chat-input').value;
            if (!msg.trim() || !activeChatId) return;

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), {
                from: currentUser.uid,
                to: activeChatId,
                msg: msg,
                ts: serverTimestamp()
            });
            document.getElementById('chat-input').value = '';
        };

        // Navigation
        window.navigate = (page) => {
            if (page !== 'home' && page !== 'auth' && !currentUser) {
                navigate('auth');
                return;
            }
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            if (page === 'chat') loadChatList();
        };

        // UI Utils
        function showLoading(show) { document.getElementById('loading-screen').classList.toggle('hidden', !show); }
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 ${type === 'error' ? 'bg-red-600' : 'bg-dark'} text-white rounded-full font-bold shadow-2xl opacity-100 transition-all z-[300]`;
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        init();
    </script>
</body>
</html>
